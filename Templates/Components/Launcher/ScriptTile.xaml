<!-- Templates/Components/Launcher/ScriptTile.xaml -->
<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <!-- Style dédié et minimaliste pour la barre de progression de la tuile -->
    <Style x:Key="ScriptTileProgressBarStyle" TargetType="ProgressBar">
        <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}"/>
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="ProgressBar">
                    <Grid>
                        <Border x:Name="PART_Track" Background="Transparent" />
                        <Border x:Name="PART_Indicator" HorizontalAlignment="Left" Background="{TemplateBinding Foreground}" />
                    </Grid>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Style principal pour la ListBox en mode "Grille de tuiles" -->
    <Style x:Key="ScriptGridListBoxStyle" TargetType="ListBox">
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled"/>
        <Setter Property="Cursor" Value="Arrow"/>
        
        <Setter Property="ItemsPanel">
            <Setter.Value>
                <ItemsPanelTemplate>
                    <WrapPanel ItemWidth="170" ItemHeight="110"/>
                </ItemsPanelTemplate>
            </Setter.Value>
        </Setter>
        
        <Setter Property="ItemTemplate">
            <Setter.Value>
                <DataTemplate>
                    <Border x:Name="TileBorder" Width="160" Height="100" Margin="0" Padding="5,10,5,10"
                            Background="{DynamicResource WhiteBrush}" 
                            BorderBrush="{DynamicResource BorderLightBrush}" 
                            BorderThickness="1" CornerRadius="8" Cursor="Hand">                       
                        <StackPanel>
                            <Grid x:Name="TileIconGrid" Width="48" Height="48" HorizontalAlignment="Center">
                                <Ellipse Fill="{Binding IconBackgroundColor}"/>
                                <Rectangle Fill="{DynamicResource WhiteBrush}" Margin="12">
                                    <Rectangle.OpacityMask>
                                        <ImageBrush ImageSource="{Binding IconSource}" Stretch="Uniform"/>
                                    </Rectangle.OpacityMask>
                                </Rectangle>
                            </Grid>
                            
                            <Grid x:Name="LoadingOverlay" Visibility="Collapsed" Margin="0,10,0,0">
                                <Border CornerRadius="6" Height="12" Background="{DynamicResource Gray200Brush}" ClipToBounds="True">
                                    <ProgressBar Value="{Binding LoadingProgress}" Style="{StaticResource ScriptTileProgressBarStyle}"/>
                                </Border>
                                
                                <TextBlock Text="{Binding LoadingStatus}" FontSize="9" FontWeight="Bold" Foreground="{DynamicResource WhiteBrush}"
                                            HorizontalAlignment="Center" VerticalAlignment="Center" TextTrimming="CharacterEllipsis">
                                    <TextBlock.Effect>
                                        <DropShadowEffect ShadowDepth="1" Color="{DynamicResource BlackColor}" Opacity="0.5" BlurRadius="2"/>
                                    </TextBlock.Effect>
                                </TextBlock>
                            </Grid>
                            
                            <TextBlock x:Name="TileText" Text="{Binding name}" TextAlignment="Center" TextWrapping="Wrap" Margin="0,10,0,0"
                                        FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                        </StackPanel>
                    </Border>
                    <DataTemplate.Triggers>
                        <!-- Règle 1 : L'élément est SÉLECTIONNÉ mais n'est PAS en cours d'exécution -->
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True"/>
                                <Condition Binding="{Binding IsRunning}" Value="False"/>
                            </MultiDataTrigger.Conditions>
                            <Setter TargetName="TileBorder" Property="BorderBrush" Value="{DynamicResource SelectionBorderBrush}"/>
                            <Setter TargetName="TileBorder" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect ShadowDepth="0" BlurRadius="10" Color="{DynamicResource PrimaryColor}" Opacity="0.3"/>
                                </Setter.Value>
                            </Setter>
                        </MultiDataTrigger>

                        <!-- Règle 2 : L'élément est SURVOLÉ mais n'est PAS sélectionné -->
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True"/>
                                <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="False"/>
                            </MultiDataTrigger.Conditions>
                            <Setter TargetName="TileBorder" Property="BorderBrush" Value="{DynamicResource SelectionBorderBrush}"/>
                            <Setter TargetName="TileBorder" Property="Background" Value="{DynamicResource SelectionHoverBackgroundBrush}"/>
                        </MultiDataTrigger>

                        <!-- Règle 3 : L'élément est EN COURS d'exécution (état de base) -->
                        <DataTrigger Binding="{Binding IsRunning}" Value="True">
                            <Setter TargetName="TileBorder" Property="Background" Value="{DynamicResource SuccessBackgroundBrush}"/>
                            <Setter TargetName="TileBorder" Property="BorderBrush" Value="{DynamicResource SuccessBrush}"/>
                            <Setter TargetName="TileBorder" Property="BorderThickness" Value="2"/>
                        </DataTrigger>
                        
                        <!-- Règle 4 : L'élément est EN COURS d'exécution ET il est SÉLECTIONNÉ -->
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding IsRunning}" Value="True"/>
                                <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True"/>
                            </MultiDataTrigger.Conditions>
                            <Setter TargetName="TileBorder" Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect ShadowDepth="0" BlurRadius="10" Color="{DynamicResource PrimaryColor}" Opacity="0.5"/>
                                </Setter.Value>
                            </Setter>
                        </MultiDataTrigger>

                        <!-- Règle 5 : L'élément est EN COURS d'exécution ET il est SURVOLÉ -->
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding IsRunning}" Value="True"/>
                                <Condition Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True"/>
                            </MultiDataTrigger.Conditions>
                            <Setter TargetName="TileBorder" Property="BorderBrush" Value="{DynamicResource SuccessHoverBrush}"/>
                        </MultiDataTrigger>
                        
                        <!-- Règle 6 : L'élément est EN COURS de chargement -->
                        <DataTrigger Binding="{Binding IsLoading}" Value="True">
                            <Setter TargetName="TileText" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="LoadingOverlay" Property="Visibility" Value="Visible"/>
                            <Setter TargetName="TileBorder" Property="BorderBrush" Value="{DynamicResource SuccessBrush}"/>
                            <Setter TargetName="TileBorder" Property="BorderThickness" Value="2"/>
                        </DataTrigger>

                        <!-- Règle 7 : L'élément est DÉSACTIVÉ (enabled=false) -->
                        <DataTrigger Binding="{Binding enabled}" Value="False">
                            <Setter TargetName="TileIconGrid" Property="Opacity" Value="0.5"/>
                            <Setter TargetName="TileText" Property="Foreground" Value="{DynamicResource TextDisabledBrush}"/>
                        </DataTrigger>
                    </DataTemplate.Triggers>
                </DataTemplate>
            </Setter.Value>
        </Setter>

        <!-- Correction finale du curseur -->
        <Setter Property="ItemContainerStyle">
            <Setter.Value>
                <Style TargetType="ListBoxItem">
                    <Setter Property="IsEnabled" Value="{Binding enabled}"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <ContentPresenter/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </Setter.Value>
        </Setter>
    </Style>

</ResourceDictionary>